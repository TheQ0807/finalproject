<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    <%@include file="../../commons/jstl.jsp" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<style type="text/css">
.container {width:1024px;}
</style>
</head>
<body>
    <c:set var="menu" value="service" />
    <c:set var="innermenu" value="reserve" />
	<%@include file="../engnavi/servicenavi.jsp" %>
	<div class="container">
		<h1>예약 현황</h1>
		<hr/>
		<div class="row">
			<div class="col-sm-12" id="blank"></div>
		</div>
		<div class="row">
			<div class="col-sm-6">
				<div class="col-sm-12">
		 			<div id="select" class="col-sm-12">
		 				<div class="col-sm-12" id="list">
			  				<div class="row">
			  					<div class="list-group" id="reserve-list">
			  						 
			  					</div>
			  				</div>
			  				<div class="row text-center">
				  				<ul class="pagination" id="page">
				  				</ul>
			  				</div>
		 				</div>
		 			</div>
				</div>
			</div>
			<div class="col-sm-6">
					<div class="row">
					<div class="col-sm-12" id="result">
	 				<table class="table table-bordered" id="reserve-detail">
	 					<tr><th>고객명</th></tr>
	 					<tr><td id="name"></td></tr>
	 					<tr><th>고객 전화번호</th></tr>
	 					<tr><td id="phone"></td></tr>
	 					<tr><th>고장 제품 종류</th></tr>
	 					<tr><td id="division" data-division=""></td></tr>
	 					<tr><th>고장 증세</th></tr>
	 					<tr><td id="symptom"></td></tr>
	 					<tr><th>완료여부</th></tr>
	 					<tr><td id="status"></td></tr>
	 					<tr><td><button id="btn" data-no="" class="btn btn-primary pull-right" data-toggle="modal" data-target="#myModal">완료</button></td></tr>
	 				</table>
					</div>
				</div>
	  		</div>
	 		</div>
	 	</div>
	 </div>
<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
	<div class="modal-dialog">
	
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title">Modal Header</h4>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label>수리형태</label>
					<select id="select-repair" class="form-control">
						<option value="">---수리 형태을 선택하세요---</option>
						<c:forEach items="${repairInfoList}" var="repair">
							<option value="${repair.id }" data-price="${repair.price }">${repair.type }</option>
						</c:forEach>
					</select>
				</div>
				<div id="usingparts-div">
					<div id="usingparts-section">
						
					</div>
					<div id="usingpart-add-btn-box" class="text-center">
						<button id="add-parts-btn" class="btn btn-primary">부품 추가</button>
					</div>
				</div>
				<div class="form-group">
					<label>총 수리비</label>
					<input name="repairPrice" id="price" class="form-control" readonly/>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary">수리완료</button>
			</div>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
$(function() {
	var partCnt = 0;
	var repairPrice = 0;
	$("#usingparts-div").hide();
	function getReserve(pageNo){
		$.ajax({
			type:"get",
			url: "/engineer/reserve/getReserve.do",
			data: {pageNo:pageNo},
			dataType: "json",
			success: function(result) {
				console.log(result);
				var htmlContents = "";
				$.each(result.serviceList, function(index, reserve) {
					var date = new Date(reserve.reservation);
					console.log(date);
					var reservation = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate() + "  " + ((date.getHours() == 9)?"09":date.getHours()) + "시" + ((date.getMinutes() == 0)?"00":"30") + "분";
					htmlContents += '<a class="list-group-item" href="'+reserve.no+'">'+reservation+'<span class="label label-primary pull-right">'+reserve.serviceStatus.status+'</span></a>';
				});
				var pageHtml = "";
				if(pageNo > 1) {
					pageHtml = "<li><a href='"+(pageNo - 1)+"'>prev</a></li>";
				}
				for(var i = result.criteria.beginPage; i <= result.criteria.endPage; ++i) {
					pageHtml += "<li><a href='"+i+"'>"+i+"</a></li>"
				}
				if(result.criteria.totalBlocks > pageNo) {
					pageHtml = "<li><a href='"+(pageNo + 1)+"'>next</a></li>";
				}
				$("#reserve-list").html(htmlContents);
				$("#page").html(pageHtml);
			}
		})
	}
	$("#select-repair").change(function(e) {
		
		if($(this).val() == "REP-SHI") {
			$("#usingparts-div").show();
			var division = $("#division").attr("data-division");
			
			$.ajax({
				type:"get",
				url:"/engineer/reserve/getASDivision.do",
				data: {divisionId : division},
				dataType: "json",
				success: function(result) {
					var htmlContents = "";
					
				}
			})
			
		} else {
			$("#usingparts-div").hide();
			$("#select-usingparts").val("");
			$("div[id^=usingpart-]").remove();
			partCnt = 0;
		}
		repairPriceChange();
	});
	
	function repairPriceChange() {
		console.log($("option[selected='true']"));
	}
	
	$("#add-parts-btn").click(function(e) {
		partCnt++;
		var htmlContents = "";
		htmlContents += '<div id="usingpart-'+partCnt+'" class="row form-group">';
		htmlContents += '<div class="col-sm-10">';
		htmlContents += '<label>사용부품</label>';
		htmlContents += '<select id="select-usingparts-'+partCnt+'" class="form-control">';
		htmlContents += '<option value="" data-price="0">--------------</option>';
		htmlContents += '</select>';
		htmlContents += '</div>';
		htmlContents += '<div class="col-sm-2">';
		htmlContents += '<label>삭제</label>';
		htmlContents += '<button id="delete-usingpart-'+partCnt+'" class="btn btn-danger">삭제하기</button>';
		htmlContents += '</div>';
		htmlContents += '</div>';
		
		$("#usingparts-section").append(htmlContents);
		
	});
	$("#usingparts-section").on("click", "button[id^=delete-usingpart-]", function(e) {
		var cntNumber = $(this).attr("id").replace("delete-usingpart-", "");
		$("#usingpart-"+cntNumber).remove();
	});
	$("#page").on("click", "a", function(e){
		e.preventDefault();
		getReserve($(this).attr("href"))
	});
	$("#reserve-list").on("click", "a", function(e) {
		e.preventDefault();
		var reserveNo = $(this).attr("href");
		
		$.ajax({
			type:"get",
			url: "/engineer/reserve/getAfterService.do",
			data: {reserveNo:reserveNo},
			dataType:"json",
			success: function(result) {
				$("#btn").hide();
				$("#name").text(result.user.name);
				$("#phone").text(result.user.phone);
				$("#division").text(result.division.name);
				$("#division").attr("data-division", result.division.id);
				$("#symptom").text(result.symptom)
				$("#status").text(result.serviceStatus.status)
				if(result.serviceStatus.id == "STA_STANDBY"){
					$("#btn").show();
					$("#btn").attr("data-no", result.no)
				}
			}
		});
	});
	$("#btn").hide();
	getReserve(1);
})
</script>
</html>